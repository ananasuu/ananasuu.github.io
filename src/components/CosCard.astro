---
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { getLocaleFromUrl, getLocalizedContent } from '../utils/i18n/i18n';

const locale = getLocaleFromUrl(Astro.url.pathname);
const cosPortfolio = await import('../data/creative/cosplays.json').then((m) => m.default);
const cosplayImages = import.meta.glob('../assets/img/card_img/*.{jpg,jpeg,png}', { eager: true });

const getCosplayImage = (imageUrl: string) => {
	const fileName = imageUrl.split('/').pop();
	if (!fileName) {
		return undefined;
	}
	const key = `../assets/img/card_img/${fileName}`;
	const mod = cosplayImages[key] as { default: ImageMetadata } | undefined;
	return mod?.default;
};
---

<ul>
    {cosPortfolio.map((cos) => {
        const localizedCos = getLocalizedContent(cos, locale);
        const image = getCosplayImage(localizedCos.imageUrl);
        const isDisabled = !localizedCos.buildbookUrl || localizedCos.buildbookUrl.trim() === '';
        return (
            <li>
                <div class="infocard costume">
                    <h3>{localizedCos.title}</h3>
                    <p class="source">{localizedCos.source}</p>
                    {image ? (
                        <Picture
                            class="card-media"
                            src={image}
                            alt={`${localizedCos.title} from ${localizedCos.source}`}
                            loading="lazy"
                            formats={['avif', 'webp', 'jpeg']}
                            inferSize
                        />
                    ) : (
                        <picture class="card-media">
                            <img
                                src={localizedCos.imageUrl}
                                alt={`${localizedCos.title} from ${localizedCos.source}`}
                                loading="lazy"
                            />
                        </picture>
                    )}
                    <p class="genres">{localizedCos.genres}</p>
                    <p>{localizedCos.description}</p>
                    <a class="button primary" href={localizedCos.buildbookUrl || ''} aria-disabled={isDisabled ? "true" : "false"}>Build Book</a>
                </div>
            </li>
        );
    })}
</ul>